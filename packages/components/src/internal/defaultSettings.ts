/* eslint-disable @typescript-eslint/quotes, sort-keys, max-len, operator-linebreak, @typescript-eslint/indent, no-underscore-dangle */
// ---------------------------------------------------------------------
// ðŸ”’ AUTOGENERATED file for @synergy-design-system/components
// Please do not edit this file directly!
// It will get recreated when running pnpm build.
// ---------------------------------------------------------------------

// Type imports
import type SynAccordion from "../components/accordion/accordion.js";
import type SynAlert from "../components/alert/alert.js";
import type SynBadge from "../components/badge/badge.js";
import type SynButton from "../components/button/button.js";
import type SynCheckbox from "../components/checkbox/checkbox.js";
import type SynCombobox from "../components/combobox/combobox.js";
import type SynDetails from "../components/details/details.js";
import type SynFile from "../components/file/file.js";
import type SynIconButton from "../components/icon-button/icon-button.js";
import type SynInput from "../components/input/input.js";
import type SynRadioButton from "../components/radio-button/radio-button.js";
import type SynRadioGroup from "../components/radio-group/radio-group.js";
import type SynRadio from "../components/radio/radio.js";
import type SynRange from "../components/range/range.js";
import type SynSelect from "../components/select/select.js";
import type SynSwitch from "../components/switch/switch.js";
import type SynTag from "../components/tag/tag.js";
import type SynTextarea from "../components/textarea/textarea.js";
import type SynValidate from "../components/validate/validate.js";
import type SynergyElement from "./synergy-element.js";
import type { SynDefaultChangedAttribute, SynDefaultSettingsChangedEvent } from "../events/events.js";

/**
 * Internal flag to check if the global event listeners have been set up
 */
let hasGlobalEventSetup = false;

/**
 * Whether to emit events when the default settings change
 */
let SYNERGY_EXPERIMENTAL_SETTING_EMIT_EVENTS = false;

type GlobalSettingsEnabledElement = SynergyElement & {
  __originalDecoratedClassName: string;
  overrideGlobalSettings: (changedProperties: SynDefaultChangedAttribute[]) => void;
};

/**
 * List of all components that have default values
 */
export const globalEventNotificationMap = new Set<GlobalSettingsEnabledElement>();

function defaultSettingsHandler(e: SynDefaultSettingsChangedEvent) {
  const { detail } = e;
  Object
    .entries(detail)
    .forEach(([componentName, changes]) => {
      globalEventNotificationMap.forEach((element) => {
        if (element.__originalDecoratedClassName !== 'undefined' && element.__originalDecoratedClassName === componentName) {
          element.overrideGlobalSettings(changes);
        }
      });
    });
}

/**
 * Enables or disables the experimental setting to emit events when the default settings change
 * @param enabled Whether to enable or disable the experimental setting
 */
export const enableExperimentalSettingEmitEvents = (enabled = true) => {
  SYNERGY_EXPERIMENTAL_SETTING_EMIT_EVENTS = enabled;

  if (!enabled) {
    hasGlobalEventSetup = false;
    window.removeEventListener('syn-default-settings-changed', defaultSettingsHandler, {
      capture: true,
    });
    return;
  }

  if (enabled && !hasGlobalEventSetup) {
    hasGlobalEventSetup = true;
    window.addEventListener('syn-default-settings-changed', defaultSettingsHandler, {
      capture: true,
    });
  }
};

/**
 * Adds an element to the global event notification map
 * Does not have any effect when SYNERGY_EXPERIMENTAL_SETTING_EMIT_EVENTS is false
 * @param element The element to add
 */
export const addGlobalEventNotification = (element: SynergyElement) => {
  if (SYNERGY_EXPERIMENTAL_SETTING_EMIT_EVENTS && !globalEventNotificationMap.has(element)) {
    globalEventNotificationMap.add(element);
  }
};

/**
 * Removes an element from the global event notification map
 * Does not have any effect when SYNERGY_EXPERIMENTAL_SETTING_EMIT_EVENTS is false
 * @param element The element to remove
 */
export const removeGlobalEventNotification = (element: SynergyElement) => {
  if (SYNERGY_EXPERIMENTAL_SETTING_EMIT_EVENTS && globalEventNotificationMap.has(element)) {
    globalEventNotificationMap.delete(element);
  }
};

// Cache for speeding up lookups
const elementPropertyCache = new Map<
  ComponentNamesWithDefaultValues,
  Record<string, unknown>
>();

// Core types

/**
 * Allows for partial recursive types
 */
type RecursivePartial<T> = {
  [P in keyof T]?: T[P] extends object ? RecursivePartial<T[P]> : T[P];
};

/**
 * Allowed value for a default setting
 * Gets the value of a given attribute for a given component
 */
type AllowedValueForDefaultSetting<
  Elm extends SynergyElement,
  Attr extends keyof Elm,
> = Elm[Attr];

/**
 * List of all components that have default values
 */
export type ComponentNamesWithDefaultValues =
  | "SynAccordion"
  | "SynAlert"
  | "SynBadge"
  | "SynButton"
  | "SynCheckbox"
  | "SynCombobox"
  | "SynDetails"
  | "SynFile"
  | "SynIconButton"
  | "SynInput"
  | "SynRadio"
  | "SynRadioButton"
  | "SynRadioGroup"
  | "SynRange"
  | "SynSelect"
  | "SynSwitch"
  | "SynTag"
  | "SynTextarea"
  | "SynValidate";

/**
 * Extracts all available default settings for a given component
 */
export type ExtractSettingsForElement<C extends SynergyElement> = {
  [key in keyof SynDefaultSettings]?: key extends keyof C
    ? AllowedValueForDefaultSetting<C, key>
    : never;
};

/**
 * Default settings map for all component values that have defaults set
 */
export type SynDefaultSettings = {
  size: {
    SynAccordion?: AllowedValueForDefaultSetting<SynAccordion, "size">;
    SynButton?: AllowedValueForDefaultSetting<SynButton, "size">;
    SynCheckbox?: AllowedValueForDefaultSetting<SynCheckbox, "size">;
    SynCombobox?: AllowedValueForDefaultSetting<SynCombobox, "size">;
    SynDetails?: AllowedValueForDefaultSetting<SynDetails, "size">;
    SynFile?: AllowedValueForDefaultSetting<SynFile, "size">;
    SynIconButton?: AllowedValueForDefaultSetting<SynIconButton, "size">;
    SynInput?: AllowedValueForDefaultSetting<SynInput, "size">;
    SynRadio?: AllowedValueForDefaultSetting<SynRadio, "size">;
    SynRadioButton?: AllowedValueForDefaultSetting<SynRadioButton, "size">;
    SynRadioGroup?: AllowedValueForDefaultSetting<SynRadioGroup, "size">;
    SynRange?: AllowedValueForDefaultSetting<SynRange, "size">;
    SynSelect?: AllowedValueForDefaultSetting<SynSelect, "size">;
    SynSwitch?: AllowedValueForDefaultSetting<SynSwitch, "size">;
    SynTag?: AllowedValueForDefaultSetting<SynTag, "size">;
    SynTextarea?: AllowedValueForDefaultSetting<SynTextarea, "size">;
  };
  variant: {
    SynAlert?: AllowedValueForDefaultSetting<SynAlert, "variant">;
    SynBadge?: AllowedValueForDefaultSetting<SynBadge, "variant">;
    SynButton?: AllowedValueForDefaultSetting<SynButton, "variant">;
    SynValidate?: AllowedValueForDefaultSetting<SynValidate, "variant">;
  };
};

// Exports

/**
 * Default settings for all components
 */
export const defaultSettings: SynDefaultSettings = {
  size: {
    SynAccordion: "medium",
    SynButton: "medium",
    SynCheckbox: "medium",
    SynCombobox: "medium",
    SynDetails: "medium",
    SynFile: "medium",
    SynIconButton: "inherit",
    SynInput: "medium",
    SynRadio: "medium",
    SynRadioButton: "medium",
    SynRadioGroup: "medium",
    SynRange: "medium",
    SynSelect: "medium",
    SynSwitch: "medium",
    SynTag: "medium",
    SynTextarea: "medium",
  },
  variant: {
    SynAlert: "primary",
    SynBadge: "primary",
    SynButton: "outline",
    SynValidate: "native",
  },
};

/**
 * Initial default settings for all components
 */
export const INITIAL_DEFAULT_SETTINGS: SynDefaultSettings = {
  size: {
    SynAccordion: "medium",
    SynButton: "medium",
    SynCheckbox: "medium",
    SynCombobox: "medium",
    SynDetails: "medium",
    SynFile: "medium",
    SynIconButton: "inherit",
    SynInput: "medium",
    SynRadio: "medium",
    SynRadioButton: "medium",
    SynRadioGroup: "medium",
    SynRange: "medium",
    SynSelect: "medium",
    SynSwitch: "medium",
    SynTag: "medium",
    SynTextarea: "medium",
  },
  variant: {
    SynAlert: "primary",
    SynBadge: "primary",
    SynButton: "outline",
    SynValidate: "native",
  },
};

/**
 * Extracts all available default settings for a given component
 * @param component The name of the component to get the settings for
 * @param from The source to get the settings from
 * @returns key value pair of found settings for the given component
 */
export const extractDefaultSettingsForElement = (
  component: ComponentNamesWithDefaultValues,
  from: "default" | "initial" = "default",
) => {
  // Check if we have the settings in cache
  // if (elementPropertyCache.has(component)) {
  //   return elementPropertyCache.get(component)!;
  // }

  const store = from === "default" ? defaultSettings : INITIAL_DEFAULT_SETTINGS;

  const allElementSettings = Object.entries(store).reduce(
    (acc: Record<string, unknown>, [key, value]) => {
      const elementSetting =
        value[component as keyof SynDefaultSettings[keyof SynDefaultSettings]];
      if (elementSetting) {
        acc[key] = elementSetting;
      }
      return acc;
    },
    {},
  );
  elementPropertyCache.set(component, allElementSettings);
  return allElementSettings;
};

/**
 * Set the default values for a given component
 * @param component The component to set the defaults for
 * @param newValues Map of new values to set
 */
export const setDefaultSettingsForElement = <C extends SynergyElement>(
  component: ComponentNamesWithDefaultValues,
  newValues: Partial<ExtractSettingsForElement<C>>,
) => {
  // List of all changes in the default settings
  const detail = {
    [component]: [] as SynDefaultChangedAttribute[],
  } as Record<string, SynDefaultChangedAttribute[]>;

  Object.entries(newValues).forEach(([key, value]) => {
    if (
      defaultSettings[key as keyof SynDefaultSettings] &&
      typeof (
        defaultSettings[key as keyof SynDefaultSettings] as Record<
          string,
          unknown
        >
      )[component] !== "undefined"
    ) {
      detail[component].push({
        attribute: key,
        newValue: value,
        oldValue:
          defaultSettings[key as keyof SynDefaultSettings][
            component as keyof SynDefaultSettings[keyof SynDefaultSettings]
          ],
      });

      (
        defaultSettings[key as keyof SynDefaultSettings] as Record<
          string,
          unknown
        >
      )[component] = value as AllowedValueForDefaultSetting<C, keyof C>;
    }
  });

  // Fire the change event
  if (SYNERGY_EXPERIMENTAL_SETTING_EMIT_EVENTS) {
    const event = new CustomEvent<typeof detail>(
      "syn-default-settings-changed",
      {
        detail,
        bubbles: true,
      },
    );
    dispatchEvent(event);
  }

  return defaultSettings;
};

/**
 * Set the global default settings
 * @param newSettings The new settings to set
 */
export const setGlobalDefaultSettings = (
  newSettings: RecursivePartial<SynDefaultSettings>,
) => {
  // List of all changes in the default settings
  const detail = {} as Record<string, SynDefaultChangedAttribute[]>;

  Object.entries(newSettings).forEach(([key, value]) => {
    if (defaultSettings[key as keyof SynDefaultSettings]) {
      Object.entries(value).forEach(([component, newValue]) => {
        // Create the component part of details if it does not exist yet
        if (!detail[component]) {
          detail[component] = [];
        }

        // Add the changed attribute to the detail object
        detail[component].push({
          attribute: key,
          newValue: newValue as unknown,
          oldValue:
            defaultSettings[key as keyof SynDefaultSettings][
              component as keyof SynDefaultSettings[keyof SynDefaultSettings]
            ],
        });

        // Set the new value
        (
          defaultSettings[key as keyof SynDefaultSettings] as Record<
            string,
            unknown
          >
        )[component] = newValue;
      });
    }
  });

  // Fire the change event
  if (SYNERGY_EXPERIMENTAL_SETTING_EMIT_EVENTS) {
    const event = new CustomEvent<typeof detail>(
      "syn-default-settings-changed",
      {
        detail,
        bubbles: true,
      },
    );
    dispatchEvent(event);
  }

  return defaultSettings;
};
